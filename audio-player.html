<link rel="import" href="/bower_components/polymer/polymer.html">
<script src="js/drawbuffer.js"></script>
<script src="js/base64array.js"></script>

<polymer-element name="audio-player" attributes="src autoplay">
  <template>
    <canvas id="sound-buffer-view" width="750" height="200"></canvas>
  </template>
  <script>
    Polymer('audio-player', {
      ready: function() {
        AudioContext = webkitAudioContext;
        this.audioContext = new AudioContext();
        this.audioSource = this.audioContext.createBufferSource();
        this.audioSource.connect(this.audioContext.destination);
        if (this.src) {
          var base64shebang = 'data:audio/mp3;base64,';
          if (this.src.indexOf(base64shebang) == 0) {
            var audioData = this.src.slice(base64shebang.length);
            this.play64(audioData);
          } else {
            var audioRequest = new XMLHttpRequest();
            audioRequest.open("GET", this.src, true);
            audioRequest.responseType = "arraybuffer";
            audioRequest.onload = function() {
              this.play(audioRequest.response);
            }.bind(this);
            audioRequest.send();
          }
        }
      },
      play: function(audioData) {
        this.audioContext.decodeAudioData(audioData, function(buffer) {
          this.audioSource.buffer = buffer;
          this.audioSource.start(0);
          this.drawBuffer(buffer);
        }.bind(this));
      },
      play64: function(base64AudioData) {
        this.play(base64DecToArr(base64AudioData).buffer);
      },
      stop: function() {
        this.audioSource.stop(0);
      },
      drawBuffer: function(buffer) {
        var canvas = this.$['sound-buffer-view'];
        drawBuffer(canvas.width, canvas.height, canvas.getContext('2d'), buffer);
      }
    });
  </script>
</polymer-element>
